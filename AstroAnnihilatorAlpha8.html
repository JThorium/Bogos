<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Astro Annihilator: Infinity (Alpha 8)</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Press Start 2P', cursive; color: white; }
        canvas { display: block; }
        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        #ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .ui-element { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9); }
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, rgba(17, 24, 39, 0.9), rgba(31, 41, 55, 0.9));
            backdrop-filter: blur(8px);
            pointer-events: all;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 20px;
            text-align: center;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .menu-button {
            background-color: #f59e0b;
            color: black;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            display: block;
            width: 100%;
        }
        .menu-button:hover {
            transform: scale(1.05);
            background-color: #eab308;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        }
        .hangar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            max-height: 300px; /* Limit height for scrollability */
            overflow-y: auto;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .ship-card {
            background-color: #1f2937;
            border: 2px solid #4b5563;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 100px;
            font-size: 0.8em;
        }
        .ship-card.selected {
            border-color: #f59e0b;
            background-color: #374151;
        }
        .ship-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #hangar-preview-container {
            width: 100%;
            height: 200px;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        #hangar-preview-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="ui-overlay">
            <!-- Start Screen -->
            <div id="startScreen" class="modal">
                <h1>Astro Annihilator: Infinity</h1>
                <button id="startButton" class="menu-button">START GAME</button>
                <button id="hangarButton" class="menu-button">HANGAR</button>
                <button id="resetProgressButton" class="menu-button">RESET PROGRESS</button>
            </div>

            <!-- Hangar Screen -->
            <div id="hangarScreen" class="modal" style="display:none;">
                <h2>HANGAR</h2>
                <div id="hangar-preview-container">
                    <canvas id="hangar-preview-canvas"></canvas>
                </div>
                <div id="hangar-ship-selector" class="hangar-grid">
                    <!-- UFOs will be loaded here -->
                </div>
                <button id="hangarBackButton" class="menu-button">BACK</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        // UFO data (50 UFOs, geometries halved)
        // Storing geometry parameters instead of instantiated THREE.Geometry objects
        const ufos = [
            { id: 'scout', name: 'Stellar Scout', geometry: { type: 'CylinderGeometry', args: [0.2, 0.4, 0.1, 32] }, colors: [1, 0, 0, 0, 1, 0], pattern: 2, stats: { moveSpeed: 0.2, health: 1, shotCooldown: 0.2, superchargePower: 1, drones: 0 }, shoot: 'single', thrusterColor: 0x00ff00, unlocked: true, cost: 0 },
            { id: 'destroyer', name: 'Nebula Destroyer', geometry: { type: 'SphereGeometry', args: [0.4, 32, 32] }, colors: [0.7, 0.7, 0.7, 0, 0, 1], pattern: 1, stats: { moveSpeed: 0.15, health: 2, shotCooldown: 0.3, superchargePower: 3, drones: 0 }, shoot: 'spread', thrusterColor: 0x0000ff, unlocked: true, cost: 0 },
            { id: 'mothership', name: 'Cosmic Mothership', geometry: { type: 'SphereGeometry', args: [0.5, 32, 32] }, colors: [0.5, 0, 1, 1, 1, 0], pattern: 0, stats: { moveSpeed: 0.1, health: 3, shotCooldown: 0.3, superchargePower: 1, drones: 2 }, shoot: 'homing', thrusterColor: 0xffff00, unlocked: true, cost: 0 },
            { id: 'ufo4', name: 'Starfire Blazer', geometry: { type: 'CylinderGeometry', args: [0.25, 0.5, 0.15, 32] }, colors: [0, 0.5, 0.5, 1, 0.5, 0], pattern: 1, stats: { moveSpeed: 0.18, health: 1, shotCooldown: 0.15, superchargePower: 1, drones: 0 }, shoot: 'single', thrusterColor: 0xffa500, unlocked: false, cost: 25 },
            { id: 'ufo5', name: 'Quantum Cube', geometry: { type: 'BoxGeometry', args: [0.4, 0.4, 0.4] }, colors: [0, 0, 0, 1, 0, 1], pattern: 2, stats: { moveSpeed: 0.12, health: 2, shotCooldown: 0.3, superchargePower: 1, drones: 1 }, shoot: 'single', thrusterColor: 0xff00ff, unlocked: false, cost: 30 },
            { id: 'ufo6', name: 'Tetra Blitz', geometry: { type: 'TetrahedronGeometry', args: [0.4] }, colors: [1, 0.8, 0, 0, 1, 1], pattern: 0, stats: { moveSpeed: 0.15, health: 1, shotCooldown: 0.5, superchargePower: 2, drones: 0 }, shoot: 'burst', thrusterColor: 0x00ffff, unlocked: false, cost: 35 },
            { id: 'ufo7', name: 'Dodeca Defender', geometry: { type: 'DodecahedronGeometry', args: [0.35] }, colors: [1, 1, 1, 1, 0, 1], pattern: 0, stats: { moveSpeed: 0.14, health: 2, shotCooldown: 0.4, superchargePower: 2, drones: 0 }, shoot: 'spread', thrusterColor: 0xff0000, unlocked: false, cost: 40 },
            { id: 'ufo8', name: 'Emerald Orb', geometry: { type: 'SphereGeometry', args: [0.45, 32, 32] }, colors: [0, 1, 0, 0.5, 0, 1], pattern: 1, stats: { moveSpeed: 0.13, health: 2, shotCooldown: 0.3, superchargePower: 1, drones: 0 }, shoot: 'homing', thrusterColor: 0x800080, unlocked: false, cost: 45 },
            { id: 'ufo9', name: 'Hex Pulse', geometry: { type: 'CylinderGeometry', args: [0.3, 0.3, 0.1, 6] }, colors: [0, 0, 1, 1, 0, 0], pattern: 1, stats: { moveSpeed: 0.16, health: 1, shotCooldown: 0.35, superchargePower: 1, drones: 0 }, shoot: 'burst', thrusterColor: 0xff0000, unlocked: false, cost: 50 },
            { id: 'ufo10', name: 'Void Lancer', geometry: { type: 'SphereGeometry', args: [0.4, 32, 32] }, colors: [1, 0.5, 0, 0, 0, 0], pattern: 1, stats: { moveSpeed: 0.12, health: 2, shotCooldown: 0.6, superchargePower: 3, drones: 0 }, shoot: 'laser', thrusterColor: 0x000000, unlocked: false, cost: 55 },
            { id: 'ufo11', name: 'Wave Rider', geometry: { type: 'CylinderGeometry', args: [0.25, 0.35, 0.2, 32] }, colors: [1, 0, 0.5, 0, 0.5, 0.5], pattern: 2, stats: { moveSpeed: 0.15, health: 1, shotCooldown: 0.3, superchargePower: 1, drones: 0 }, shoot: 'wave', thrusterColor: 0x00ff00, unlocked: false, cost: 60 },
            { id: 'ufo12', name: 'Nova Bomber', geometry: { type: 'ConeGeometry', args: [0.35, 0.5, 32] }, colors: [1, 1, 0, 0.5, 0, 0.5], pattern: 1, stats: { moveSpeed: 0.14, health: 2, shotCooldown: 0.5, superchargePower: 2, drones: 0 }, shoot: 'explosive', thrusterColor: 0x800080, unlocked: false, cost: 65 },
            { id: 'ufo13', name: 'Astral Fortress', geometry: { type: 'BoxGeometry', args: [0.45, 0.45, 0.45] }, colors: [0, 1, 1, 1, 0.8, 0], pattern: 0, stats: { moveSpeed: 0.1, health: 3, shotCooldown: 0.4, superchargePower: 1, drones: 0 }, shoot: 'single', thrusterColor: 0xffd700, unlocked: false, cost: 70 },
            { id: 'ufo14', name: 'Comet Striker', geometry: { type: 'CylinderGeometry', args: [0.3, 0.6, 0.2, 32] }, colors: [1, 0, 0, 1, 1, 1], pattern: 0, stats: { moveSpeed: 0.17, health: 1, shotCooldown: 0.1, superchargePower: 1, drones: 0 }, shoot: 'single', thrusterColor: 0xffffff, unlocked: false, cost: 75 },
            { id: 'ufo15', name: 'Triad Enforcer', geometry: { type: 'ConeGeometry', args: [0.3, 0.6, 32] }, colors: [0, 0, 0, 0, 1, 0], pattern: 2, stats: { moveSpeed: 0.15, health: 2, shotCooldown: 0.3, superchargePower: 1, drones: 0 }, shoot: 'triple', thrusterColor: 0x00ff00, unlocked: false, cost: 80 },
            { id: 'ufo16', name: 'Arc Vortex', geometry: { type: 'TorusGeometry', args: [0.3, 0.1, 16, 32] }, colors: [0.5, 0.5, 0.5, 1, 0, 0], pattern: 1, stats: { moveSpeed: 0.16, health: 1, shotCooldown: 0.25, superchargePower: 1, drones: 0 }, shoot: 'arc', thrusterColor: 0xff0000, unlocked: false, cost: 85 },
            { id: 'ufo17', name: 'Spiral Phantom', geometry: { type: 'IcosahedronGeometry', args: [0.35] }, colors: [0, 1, 1, 1, 0, 1], pattern: 0, stats: { moveSpeed: 0.14, health: 2, shotCooldown: 0.4, superchargePower: 2, drones: 0 }, shoot: 'spiral', thrusterColor: 0xff00ff, unlocked: false, cost: 90 },
            { id: 'ufo18', name: 'Meteor Skirmisher', geometry: { type: 'CylinderGeometry', args: [0.25, 0.45, 0.15, 32] }, colors: [1, 0, 1, 0, 1, 0], pattern: 2, stats: { moveSpeed: 0.15, health: 1, shotCooldown: 0.25, superchargePower: 1, drones: 0 }, shoot: 'single', thrusterColor: 0x00ff00, unlocked: false, cost: 95 },
            { id: 'ufo19', name: 'Seeker Sphere', geometry: { type: 'SphereGeometry', args: [0.4, 32, 32] }, colors: [0, 0, 1, 1, 0.5, 0], pattern: 1, stats: { moveSpeed: 0.13, health: 2, shotCooldown: 0.35, superchargePower: 1, drones: 0 }, shoot: 'homing', thrusterColor: 0xffa500, unlocked: false, cost: 100 },
            { id: 'ufo20', name: 'Burst Guardian', geometry: { type: 'BoxGeometry', args: [0.35, 0.35, 0.35] }, colors: [1, 1, 0, 0, 0, 1], pattern: 0, stats: { moveSpeed: 0.12, health: 2, shotCooldown: 0.5, superchargePower: 2, drones: 0 }, shoot: 'burst', thrusterColor: 0x0000ff, unlocked: false, cost: 110 },
            { id: 'ufo21', name: 'Trident Fury', geometry: { type: 'ConeGeometry', args: [0.3, 0.5, 32] }, colors: [0, 1, 0, 1, 0.8, 0], pattern: 2, stats: { moveSpeed: 0.17, health: 1, shotCooldown: 0.2, superchargePower: 1, drones: 0 }, shoot: 'triple', thrusterColor: 0xff0000, unlocked: false, cost: 120 },
            { id: 'ufo22', name: 'Starshot Crusader', geometry: { type: 'TetrahedronGeometry', args: [0.4] }, colors: [1, 0, 0.5, 0, 1, 1], pattern: 1, stats: { moveSpeed: 0.14, health: 2, shotCooldown: 0.3, superchargePower: 1, drones: 0 }, shoot: 'spread', thrusterColor: 0x00ffff, unlocked: false, cost: 130 },
            { id: 'ufo23', name: 'Laser Sentinel', geometry: { type: 'DodecahedronGeometry', args: [0.35] }, colors: [0.5, 0, 1, 1, 1, 0], pattern: 0, stats: { moveSpeed: 0.13, health: 2, shotCooldown: 0.3, superchargePower: 1, drones: 0 }, shoot: 'laser', thrusterColor: 0xffff00, unlocked: false, cost: 140 },
            { id: 'ufo24', name: 'Wavebreaker', geometry: { type: 'CylinderGeometry', args: [0.25, 0.4, 0.15, 32] }, colors: [0, 0.5, 0.5, 1, 0, 1], pattern: 2, stats: { moveSpeed: 0.15, health: 1, shotCooldown: 0.25, superchargePower: 1, drones: 0 }, shoot: 'wave', thrusterColor: 0xff00ff, unlocked: false, cost: 150 },
            { id: 'ufo25', name: 'Detonator', geometry: { type: 'SphereGeometry', args: [0.45, 32, 32] }, colors: [1, 0.5, 0, 0, 1, 0], pattern: 1, stats: { moveSpeed: 0.12, health: 2, shotCooldown: 0.5, superchargePower: 2, drones: 0 }, shoot: 'explosive', thrusterColor: 0x800080, unlocked: false, cost: 160 },
            { id: 'ufo26', name: 'Gravity Bastion', geometry: { type: 'BoxGeometry', args: [0.4, 0.4, 0.4] }, colors: [0, 0, 1, 1, 0.8, 0], pattern: 0, stats: { moveSpeed: 0.1, health: 3, shotCooldown: 0.4, superchargePower: 1, drones: 0 }, shoot: 'single', thrusterColor: 0xffd700, unlocked: false, cost: 170 },
            { id: 'ufo27', name: 'Arc Predator', geometry: { type: 'ConeGeometry', args: [0.35, 0.6, 32] }, colors: [1, 0, 0, 0, 0.5, 0.5], pattern: 2, stats: { moveSpeed: 0.16, health: 1, shotCooldown: 0.2, superchargePower: 1, drones: 0 }, shoot: 'arc', thrusterColor: 0x00ff00, unlocked: false, cost: 180 },
            { id: 'ufo28', name: 'Spiral Wraith', geometry: { type: 'TorusGeometry', args: [0.3, 0.1, 16, 32] }, colors: [0.5, 1, 0, 1, 0, 0], pattern: 1, stats: { moveSpeed: 0.14, health: 2, shotCooldown: 0.3, superchargePower: 1, drones: 0 }, shoot: 'spiral', thrusterColor: 0xff0000, unlocked: false, cost: 190 },
            { id: 'ufo29', name: 'Homing Specter', geometry: { type: 'IcosahedronGeometry', args: [0.35] }, colors: [0, 1, 1, 1, 0.5, 0], pattern: 0, stats: { moveSpeed: 0.13, health: 2, shotCooldown: 0.35, superchargePower: 1, drones: 0 }, shoot: 'homing', thrusterColor: 0xffa500, unlocked: false, cost: 200 },
            { id: 'ufo30', name: 'Pulse Interceptor', geometry: { type: 'CylinderGeometry', args: [0.25, 0.45, 0.15, 32] }, colors: [1, 0, 1, 0, 1, 0], pattern: 2, stats: { moveSpeed: 0.15, health: 1, shotCooldown: 0.25, superchargePower: 1, drones: 0 }, shoot: 'single', thrusterColor: 0x0000ff, unlocked: false, cost: 210 },
            { id: 'ufo31', name: 'Blast Orbiter', geometry: { type: 'SphereGeometry', args: [0.4, 32, 32] }, colors: [0, 0.5, 0.5, 1, 0, 1], pattern: 1, stats: { moveSpeed: 0.12, health: 2, shotCooldown: 0.5, superchargePower: 2, drones: 0 }, shoot: 'burst', thrusterColor: 0xffff00, unlocked: false, cost: 220 },
            { id: 'ufo32', name: 'Triad Vanguard', geometry: { type: 'BoxGeometry', args: [0.35, 0.35, 0.35] }, colors: [1, 1, 0, 0, 0, 1], pattern: 0, stats: { moveSpeed: 0.1, health: 3, shotCooldown: 0.4, superchargePower: 1, drones: 0 }, shoot: 'triple', thrusterColor: 0xff00ff, unlocked: false, cost: 230 },
            { id: 'ufo33', name: 'Scatter Storm', geometry: { type: 'ConeGeometry', args: [0.3, 0.5, 32] }, colors: [0, 1, 0, 1, 0.8, 0], pattern: 2, stats: { moveSpeed: 0.17, health: 1, shotCooldown: 0.2, superchargePower: 1, drones: 0 }, shoot: 'spread', thrusterColor: 0x800080, unlocked: false, cost: 240 },
            { id: 'ufo34', name: 'Beam Marauder', geometry: { type: 'TetrahedronGeometry', args: [0.4] }, colors: [1, 0, 0.5, 0, 1, 1], pattern: 1, stats: { moveSpeed: 0.14, health: 2, shotCooldown: 0.3, superchargePower: 1, drones: 0 }, shoot: 'laser', thrusterColor: 0xffd700, unlocked: false, cost: 250 },
            { id: 'ufo35', name: 'Ripple Enigma', geometry: { type: 'DodecahedronGeometry', args: [0.35] }, colors: [0.5, 0, 1, 1, 0, 0], pattern: 0, stats: { moveSpeed: 0.13, health: 2, shotCooldown: 0.35, superchargePower: 1, drones: 0 }, shoot: 'wave', thrusterColor: 0x00ff00, unlocked: false, cost: 260 },
            { id: 'ufo36', name: 'Shockwave Titan', geometry: { type: 'CylinderGeometry', args: [0.25, 0.4, 0.15, 32] }, colors: [0, 0, 1, 1, 0.5, 0], pattern: 2, stats: { moveSpeed: 0.15, health: 1, shotCooldown: 0.25, superchargePower: 1, drones: 0 }, shoot: 'explosive', thrusterColor: 0xff0000, unlocked: false, cost: 270 },
            { id: 'ufo37', name: 'Flare Dominator', geometry: { type: 'SphereGeometry', args: [0.45, 32, 32] }, colors: [1, 0.5, 0, 0, 1, 0], pattern: 1, stats: { moveSpeed: 0.12, health: 2, shotCooldown: 0.5, superchargePower: 2, drones: 0 }, shoot: 'single', thrusterColor: 0xffa500, unlocked: false, cost: 280 },
            { id: 'ufo38', name: 'Crescent Avenger', geometry: { type: 'BoxGeometry', args: [0.4, 0.4, 0.4] }, colors: [0, 0.5, 0.5, 1, 0, 1], pattern: 0, stats: { moveSpeed: 0.1, health: 3, shotCooldown: 0.4, superchargePower: 1, drones: 0 }, shoot: 'arc', thrusterColor: 0x0000ff, unlocked: false, cost: 290 },
            { id: 'ufo39', name: 'Helix Stalker', geometry: { type: 'ConeGeometry', args: [0.35, 0.6, 32] }, colors: [1, 0, 0, 0, 0.5, 0.5], pattern: 2, stats: { moveSpeed: 0.16, health: 1, shotCooldown: 0.2, superchargePower: 1, drones: 0 }, shoot: 'spiral', thrusterColor: 0xffff00, unlocked: false, cost: 300 },
            { id: 'ufo40', name: 'Tracker Nebula', geometry: { type: 'TorusGeometry', args: [0.3, 0.1, 16, 32] }, colors: [0.5, 1, 0, 1, 0, 0], pattern: 1, stats: { moveSpeed: 0.14, health: 2, shotCooldown: 0.3, superchargePower: 1, drones: 0 }, shoot: 'homing', thrusterColor: 0xff00ff, unlocked: false, cost: 310 },
            { id: 'ufo41', name: 'Aether Striker', geometry: { type: 'IcosahedronGeometry', args: [0.35] }, colors: [0, 1, 1, 1, 0.8, 0], pattern: 0, stats: { moveSpeed: 0.13, health: 2, shotCooldown: 0.35, superchargePower: 1, drones: 0 }, shoot: 'single', thrusterColor: 0x800080, unlocked: false, cost: 320 },
            { id: 'ufo42', name: 'Volley Reaper', geometry: { type: 'CylinderGeometry', args: [0.25, 0.45, 0.15, 32] }, colors: [1, 0, 1, 0, 1, 0], pattern: 2, stats: { moveSpeed: 0.15, health: 1, shotCooldown: 0.25, superchargePower: 1, drones: 0 }, shoot: 'burst', thrusterColor: 0xffd700, unlocked: false, cost: 330 },
            { id: 'ufo43', name: 'Triad Monarch', geometry: { type: 'SphereGeometry', args: [0.4, 32, 32] }, colors: [0, 0.5, 0.5, 1, 0, 1], pattern: 1, stats: { moveSpeed: 0.12, health: 2, shotCooldown: 0.5, superchargePower: 2, drones: 0 }, shoot: 'triple', thrusterColor: 0x00ff00, unlocked: false, cost: 340 },
            { id: 'ufo44', name: 'Fanfire Juggernaut', geometry: { type: 'BoxGeometry', args: [0.35, 0.35, 0.35] }, colors: [1, 1, 0, 0, 0, 1], pattern: 0, stats: { moveSpeed: 0.1, health: 3, shotCooldown: 0.4, superchargePower: 1, drones: 0 }, shoot: 'spread', thrusterColor: 0xff0000, unlocked: false, cost: 350 },
            { id: 'ufo45', name: 'Ray Sovereign', geometry: { type: 'ConeGeometry', args: [0.3, 0.5, 32] }, colors: [0, 1, 0, 1, 0.8, 0], pattern: 2, stats: { moveSpeed: 0.17, health: 1, shotCooldown: 0.2, superchargePower: 1, drones: 0 }, shoot: 'laser', thrusterColor: 0xffa500, unlocked: false, cost: 360 },
            { id: 'ufo46', name: 'Surge Pathfinder', geometry: { type: 'TetrahedronGeometry', args: [0.4] }, colors: [1, 0, 0.5, 0, 1, 1], pattern: 1, stats: { moveSpeed: 0.14, health: 2, shotCooldown: 0.3, superchargePower: 1, drones: 0 }, shoot: 'wave', thrusterColor: 0x0000ff, unlocked: false, cost: 370 },
            { id: 'ufo47', name: 'Core Devastator', geometry: { type: 'DodecahedronGeometry', args: [0.35] }, colors: [0.5, 0, 1, 1, 0, 0], pattern: 0, stats: { moveSpeed: 0.13, health: 2, shotCooldown: 0.35, superchargePower: 1, drones: 0 }, shoot: 'explosive', thrusterColor: 0xffff00, unlocked: false, cost: 380 },
            { id: 'ufo48', name: 'Swift Nebula', geometry: { type: 'CylinderGeometry', args: [0.25, 0.4, 0.15, 32] }, colors: [0, 0, 1, 1, 0.5, 0], pattern: 2, stats: { moveSpeed: 0.15, health: 1, shotCooldown: 0.25, superchargePower: 1, drones: 0 }, shoot: 'single', thrusterColor: 0xff00ff, unlocked: false, cost: 390 },
            { id: 'ufo49', name: 'Crimson Halo', geometry: { type: 'SphereGeometry', args: [0.45, 32, 32] }, colors: [1, 0.5, 0, 0, 1, 0], pattern: 1, stats: { moveSpeed: 0.12, health: 2, shotCooldown: 0.5, superchargePower: 2, drones: 0 }, shoot: 'arc', thrusterColor: 0x800080, unlocked: false, cost: 400 },
            { id: 'ufo50', name: 'Vortex Emperor', geometry: { type: 'BoxGeometry', args: [0.4, 0.4, 0.4] }, colors: [0, 0.5, 0.5, 1, 0, 1], pattern: 0, stats: { moveSpeed: 0.1, health: 3, shotCooldown: 0.4, superchargePower: 1, drones: 0 }, shoot: 'spiral', thrusterColor: 0xffd700, unlocked: false, cost: 420 }
        ];

        // Three.js setup for game
        let scene, camera, renderer, playerShip;
        const gameCanvas = document.getElementById('gameCanvas');
        const uiOverlay = document.getElementById('ui-overlay');
        let screenWidth, screenHeight;

        // Three.js setup for hangar preview
        let hangarScene, hangarCamera, hangarRenderer, hangarPreviewShip;
        const hangarPreviewCanvas = document.getElementById('hangar-preview-canvas');

        // Game state
        let selectedUFOId = localStorage.getItem('selectedUFOId') || 'scout';
        let unlockedUFOs = new Set(JSON.parse(localStorage.getItem('unlockedUFOs') || '["scout"]'));

        // UI Elements
        const startScreen = document.getElementById('startScreen');
        const startButton = document.getElementById('startButton');
        const hangarButton = document.getElementById('hangarButton');
        const resetProgressButton = document.getElementById('resetProgressButton');
        const hangarScreen = document.getElementById('hangarScreen');
        const hangarShipSelector = document.getElementById('hangar-ship-selector');
        const hangarBackButton = document.getElementById('hangarBackButton');

        function initGameScene() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);

            // Camera
            screenWidth = window.innerWidth;
            screenHeight = window.innerHeight;
            camera = new THREE.PerspectiveCamera(75, screenWidth / screenHeight, 0.1, 1000);
            camera.position.z = 5;

            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: gameCanvas, antialias: true });
            renderer.setSize(screenWidth, screenHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 1, 1);
            scene.add(directionalLight);

            // Player Ship (placeholder for now)
            playerShip = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshBasicMaterial({ color: 0x00ff00 }));
            scene.add(playerShip);

            // Handle window resize
            window.addEventListener('resize', onWindowResize, false);
            function onWindowResize() {
                screenWidth = window.innerWidth;
                screenHeight = window.innerHeight;
                camera.aspect = screenWidth / screenHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(screenWidth, screenHeight);
            }

            animateGameScene();
        }

        function animateGameScene() {
            requestAnimationFrame(animateGameScene);
            // Game logic updates here
            playerShip.rotation.x += 0.01;
            playerShip.rotation.y += 0.01;
            renderer.render(scene, camera);
        }

        function initHangarPreviewScene() {
            hangarScene = new THREE.Scene();
            hangarCamera = new THREE.PerspectiveCamera(75, hangarPreviewCanvas.clientWidth / hangarPreviewCanvas.clientHeight, 0.1, 1000);
            hangarCamera.position.z = 2; // Closer for preview

            hangarRenderer = new THREE.WebGLRenderer({ canvas: hangarPreviewCanvas, antialias: true, alpha: true });
            hangarRenderer.setSize(hangarPreviewCanvas.clientWidth, hangarPreviewCanvas.clientHeight);
            hangarRenderer.setPixelRatio(window.devicePixelRatio);

            const ambientLight = new THREE.AmbientLight(0x404040);
            hangarScene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            hangarScene.add(directionalLight);

            // OrbitControls for interaction in hangar preview
            const controls = new THREE.OrbitControls(hangarCamera, hangarRenderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.screenSpacePanning = false;
            controls.maxPolarAngle = Math.PI / 2;
            controls.autoRotate = true; // Automatically rotate the model

            animateHangarPreviewScene(controls);
        }

        function animateHangarPreviewScene(controls) {
            requestAnimationFrame(() => animateHangarPreviewScene(controls));
            controls.update(); // Required if controls.enableDamping or controls.autoRotate are set to true
            if (hangarPreviewShip) {
                hangarPreviewShip.rotation.y += 0.005; // Gentle rotation
            }
            hangarRenderer.render(hangarScene, hangarCamera);
        }

        function loadUFOsIntoHangar() {
            hangarShipSelector.innerHTML = '';
            ufos.forEach(ufo => {
                const isUnlocked = unlockedUFOs.has(ufo.id);
                const card = document.createElement('div');
                card.className = `ship-card ${isUnlocked ? '' : 'locked'} ${ufo.id === selectedUFOId ? 'selected' : ''}`;
                card.dataset.ufoId = ufo.id;
                card.innerHTML = `
                    <h3>${ufo.name}</h3>
                    <p>Speed: ${ufo.stats.moveSpeed}</p>
                    <p>Health: ${ufo.stats.health}</p>
                    <p>Cost: ${ufo.cost}</p>
                    ${!isUnlocked ? '<p style="color:red;">LOCKED</p>' : ''}
                `;
                card.addEventListener('click', () => {
                    if (isUnlocked) {
                        selectedUFOId = ufo.id;
                        localStorage.setItem('selectedUFOId', selectedUFOId);
                        updateHangarSelection();
                        updateHangarPreview(ufo);
                    }
                });
                hangarShipSelector.appendChild(card);
            });
            // Initial preview load
            const initialUFO = ufos.find(u => u.id === selectedUFOId);
            if (initialUFO) {
                updateHangarPreview(initialUFO);
            }
        }

        function updateHangarSelection() {
            document.querySelectorAll('.ship-card').forEach(card => {
                if (card.dataset.ufoId === selectedUFOId) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        function updateHangarPreview(ufo) {
            // Clear previous model
            if (hangarPreviewShip) {
                hangarScene.remove(hangarPreviewShip);
                hangarPreviewShip.geometry.dispose();
                hangarPreviewShip.material.dispose();
            }

            // Create geometry dynamically from parameters
            let geometry;
            console.log("UFO geometry type:", ufo.geometry.type); // Debugging line
            switch (ufo.geometry.type) {
                case 'CylinderGeometry':
                    geometry = new THREE.CylinderGeometry(...ufo.geometry.args);
                    break;
                case 'SphereGeometry':
                    geometry = new THREE.SphereGeometry(...ufo.geometry.args);
                    break;
                case 'BoxGeometry':
                    geometry = new THREE.BoxGeometry(...ufo.geometry.args);
                    break;
                case 'TetrahedronGeometry':
                    geometry = new THREE.TetrahedronGeometry(...ufo.geometry.args);
                    break;
                case 'DodecahedronGeometry':
                    geometry = new THREE.DodecahedronGeometry(...ufo.geometry.args);
                    break;
                case 'TorusGeometry':
                    geometry = new THREE.TorusGeometry(...ufo.geometry.args);
                    break;
                case 'IcosahedronGeometry':
                    geometry = new THREE.IcosahedronGeometry(...ufo.geometry.args);
                    break;
                case 'ConeGeometry':
                    geometry = new THREE.ConeGeometry(...ufo.geometry.args);
                    break;
                default:
                    geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5); // Default to a box if type is unknown
            }

            const material = new THREE.MeshPhongMaterial({
                color: new THREE.Color(ufo.colors[0], ufo.colors[1], ufo.colors[2]), // Use first color for base
                specular: new THREE.Color(ufo.colors[3], ufo.colors[4], ufo.colors[5]), // Use second color for specular
                shininess: 30
            });
            hangarPreviewShip = new THREE.Mesh(geometry, material);
            hangarScene.add(hangarPreviewShip);
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            startScreen.style.display = 'none';
            uiOverlay.style.pointerEvents = 'none';
            initGameScene();
            // TODO: Start actual game loop
        });

        hangarButton.addEventListener('click', () => {
            startScreen.style.display = 'none';
            hangarScreen.style.display = 'block';
            initHangarPreviewScene(); // Initialize hangar scene when entering
            loadUFOsIntoHangar();
        });

        hangarBackButton.addEventListener('click', () => {
            hangarScreen.style.display = 'none';
            startScreen.style.display = 'block';
            // Dispose hangar renderer and scene to free up resources
            if (hangarRenderer) {
                hangarRenderer.dispose();
                hangarRenderer = null;
            }
            if (hangarScene) {
                hangarScene.traverse((object) => {
                    if (object.isMesh) {
                        object.geometry.dispose();
                        object.material.dispose();
                    }
                });
                hangarScene = null;
            }
            // Stop animation loop
            // No direct way to stop requestAnimationFrame, but resources are disposed
        });

        resetProgressButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                localStorage.clear();
                selectedUFOId = 'scout';
                unlockedUFOs = new Set(['scout']);
                alert('Progress has been reset.');
                loadUFOsIntoHangar(); // Refresh hangar UI
            }
        });

        // Initialize game on load (display start screen)
        document.addEventListener('DOMContentLoaded', () => {
            startScreen.style.display = 'block';
            uiOverlay.style.pointerEvents = 'auto'; // Enable interaction with modals
        });
    </script>
</body>
</html>
